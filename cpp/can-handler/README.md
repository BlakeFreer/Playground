# CAN Handler

Potential solutions for <https://github.com/macformula/racecar/issues/242>.

It does not implement a queue, but this may not be needed anyways. Adding a queue would be quite easy, even queues for some msg and not others, since the `GetLatest<MsgType>()` method can be specialized independently for any message.

Besides the upgrade to more modern features like templates / concepts / optional, this library is significantly simpler than the existing `racecar/` library.

- There is no msg registry layer -> this functionality is incorportated into the bus. This does not cause any issues for the parent Bus class since it is defined _just_ enough to make a complete class before anything is autogenerated. We never need an instance of `Bus` so we will always be working on an autogenerated one within the context of a project.
- Messages are not split into Rx and Tx messages so they don't need to repeat their structure.
  - Received messages are still filtered by the Bus's switch statement, and it would be equally easy to add some filtering and return an error in Bus.send() of a node tries to send a message that it shouldn't.
  - Alternatively (and even better) we could split the Message concept into an Rx which supports `::decode()` and Tx which supports `.encode()`. Then the type system will prevent the developer from perfoming illegal operations, but the code for any message can still exist in a single struct, even if it is both Tx and Rx.
- Less methods are defined in the interfaces / abstract classes at all layers. A greater focus is placed on the generated code.
  - ex `unpack_shift` and `pack_shift` are not defined anywhere. We will let the cangen template decide how to unpack rather than coupling it to some methods on the Message class.
- By moving to public `.encode()` and `::decode()` methods on `Message`, we no longer need to make Msgs and Bus friends and can get rid of the `protected` method-relaying methods (like [Clone and ID in MsgRegistry](https://github.com/macformula/racecar/blob/main/firmware/shared/comms/can/msg_registry.h#L15)).
  - Also, as messages now implement a concept rather than inherit from an abstract class, we can get rid of the virtual function overhead during the old `.Pack` and `.Unpack` calls.
- Since the Base is able to directly add messages to Bus, we can remove `Bus.Update()`. All messages are handled and made available in the background.

## Usage

```bash
make
./build/main
```

## Questions

Can the concrete Bus classes like VehBus be made into singletons to avoid having two copies? Not a critical issue.
