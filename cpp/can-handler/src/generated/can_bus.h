/**
 * @brief This file would be autogenerated by cangen
 */

#include "can_msgs.h"
#include "canlib/base.h"
#include "canlib/bus.h"
#include "canlib/msg.h"

namespace can {

class VehBus : public Bus {
   public:
    VehBus(Base& can_base) : Bus(can_base) {}

    /**
     * @brief Get the Latest message of any type. Uses templates to make it
     * really easy to call.
     * @example `auto msg = bus.GetLatest<PackStateMsg>();`
     * Notice it returns an optional, not necessarily a message.
     */
    template <Message T>
    std::optional<T> GetLatest() const;

   private:
    void AddMessage(const RawMessage& msg) {
        // This switch is faster than a map lookup. It is autogenerated so there
        // is not cost to writing it.
        // Filtering is cleanly handled by the `default` case - any message
        // which isn't part of this node will fall through the default.
        switch (msg.id) {
            case PackStateMsg::id():
                pack_StateMsg_ = PackStateMsg::decode(msg);
                break;
            case ContactorStateMsg::id():
                constactor_StateMsg_ = ContactorStateMsg::decode(msg);
                break;
            default:
                // ignore message -> not part of registry
                break;
        }
    }

    // All messages start empty. As soon as one arrives it will be filled.
    // We would could add PopLastest() to optionally get then remove the latest
    // message.
    std::optional<PackStateMsg> pack_StateMsg_ = std::nullopt;
    std::optional<ContactorStateMsg> constactor_StateMsg_ = std::nullopt;

    friend class Base;
};

// Specialize the GetLatest template for each message type. We could also make
// individual getters like GetLatestPackStateMsg() and
// GetLatestContactorStateMsg() but I think the template is cleaner.
template <>
std::optional<PackStateMsg> VehBus::GetLatest<PackStateMsg>() const {
    return pack_StateMsg_;
}

template <>
std::optional<ContactorStateMsg> VehBus::GetLatest<ContactorStateMsg>() const {
    return constactor_StateMsg_;
}

}  // namespace can